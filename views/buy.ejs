<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Air puri | Buy</title>

		<% include head.ejs %>
	</head>

<body>
	<div id="app">
	<!-- Start Content -->
	<section id="buy" class="wrapper">

		<!-- Start Header -->
		<header id="" class="page-header-container">
			<div class="container-fluid page-header-content">
				<div class="page-overlay"></div>
				<h2>구매 하기</h2>
			</div>
		</header>
		<!-- End Header -->
		<% include navbar.ejs %>

		<!-- Start Content -->
		<!-- Start Products  -->
		<section id="products-1" class="products-l2 block gray">
			<div class="container">
				<div class="row">
					<!-- Start Product 1 -->
					<div id="product-l2-1" class="col-md-6 col product-l2">

						<div class="product-l2-block">

							<div class="product-l2-bg">
								<div class="bg-img"></div>
								<div class="bg-content"></div>
							</div>

							<!-- Start Product Images -->
							<div class="product-l2-img">
								<div class="product-l2-container">
									<img src="http://via.placeholder.com/196x225" alt="product">
								</div>
							</div>
							<!-- End Product Images -->

							<!-- Start Product Content -->
							<div class="product-l2-content">
								<div class="product-info">

									<h3>AIR PURI 청정기</h3>
									<p class="version">차량용</p>
									<span class="sale">400,000원</span> <span class="sale-price">300,000원</span>

									<p class="desc">Air puri 차량용 청정기 적어줄 말을 써주세요</p>
									<div class="order" style="padding-top:0px;padding-bottom:0px;">
										<div class="order-form-content">
										<div class="col-md-6">
											<div class="l2-bnt-block">
												<select class="order-country" v-on:change="onChange"  style="margin-top:0px;">
													<option v-for="option in car_option" v-bind:value="option.value">{{ option.text }}</option>
												</select>
											</div>
											</div>
										</div>									
									</div>
								</div>
							</div>
							<!-- End Product Content -->

						</div><!-- .product-l2-block -->
					</div>
					<!-- End Product 1 -->

					<!-- Start Product 2 -->
					<div id="product-l2-2" class="col-md-6 product-l2">

						<div class="product-l2-block">

							<div class="product-l2-bg">
								<div class="bg-img"></div>
								<div class="bg-content"></div>
							</div>

							<!-- Start Product Images -->
							<div class="product-l2-img">
								<div class="product-l2-container">
									<img src="http://via.placeholder.com/196x225" alt="product">
								</div>
							</div>
							<!-- End Product Images -->

							<!-- Start Product Content -->
							<div class="product-l2-content">
								<div class="product-info">

									<h3>AIR PURI 청정기</h3>
									<p class="version">실내용</p>
									<span>400,000원</span>
									<span class="sale-price">100000원</span>

									<p class="desc">Air puri  청정기 적어줄 말을 써 주세요</p>

									<div class="l2-bnt-block">
										<a  class="button buy-button"  title="Buy Now">comming soon</a>
									</div>

								</div>
							</div>
							<!-- End Product Content -->

						</div><!-- .product-l2-block -->
					</div>
					<!-- End Product 2 -->
				</div>
				<br />
				<div class="row">
					<div class="col-md-6"></div>
					<div class="col-md-6">
						<h3 class="text-right">총 결제 금액</h2>
						<h2 class="text-right">{{ totalPrice }} 원<small>(vat 포함)</small></h3>
						<div class="l2-bnt-block text-right">
							<a class="button buy-button"  title="구매 하기" v-on:click="showModal()">구매 하기</a>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- End Products / Layout 3 -->
		<!-- End Content -->

		<% include footer.ejs %>

	</section>
	<!-- End Content -->
	<!-- Start Popup -->
	<section id="order" class="order mfp-hide">

		<div class="order-form-bg"></div>

		<!-- Start Form Header -->
		<div class="order-form-header clearfix">
			<div class="order-img">
			</div>
			<div class="order-desc">
				<h2>최종 결제 금액</h2>
				<p class="version">적을 내용을 입력해주세요</p>
				<span>{{ totalPrice }} 원</span>
				<p>적을 내용을 입력해주세요</p>
			</div>
		</div>
		<!-- End Form Header -->

		<div class="order-form-content">

			<!-- Start Order Form -->
			<form id="order-form" class="order-form">

				<div class="col-md-12">
					<h3>결제 정보 입력</h3>
				</div>

				<div class="col-md-6">
					<input v-model="order_name" class="order-f-name" type="text" name="order-f-name" placeholder="주문자 이름">
				</div>

				<div class="col-md-6">
					<input v-model="order_phone" class="order-l-name" type="text" name="order-l-name" placeholder="주문자 핸드폰(- 제외)">
				</div>
					
				<div class="col-md-12">
					<input v-model="order_email" class="order-email" type="text" name="order-email" placeholder="이메일(주문 내역 확인 시 필요합니다.)">
				</div>
				<div class="col-md-6">
					<input v-model="receiver_name" class="order-f-name" type="text" name="order-f-name" placeholder="수령인 이름">
				</div>

				<div class="col-md-6">
					<input v-model="receiver_phone" class="order-l-name" type="text" name="order-l-name" placeholder="수령인 핸드폰(- 제외)">
				</div>

				<div class="col-md-6">
					<input v-model="post_code" class="order-address" type="text" name="order-address" placeholder="우편번호" disabled>
				</div>

				<div class="col-md-6 order-button-block">
					<button type="button" class="button order-button" v-on:click="showPostCode()" title="Order">우편번호 찾기</button>
				</div>

				<div class="col-md-12">
					<input v-model="normal_address" class="order-state" type="text" name="order-state" placeholder="기본 주소" disabled>
				</div>
				
				<div class="col-md-12">
					<input v-model="addtional_address" class="order-state" type="text" name="order-state" placeholder="상세 주소">
				</div>
				<div id="layer" style="display:none;position:fixed;overflow:hidden;z-index:1;-webkit-overflow-scrolling:touch;">
					<img src="//t1.daumcdn.net/localimg/localimages/07/postcode/320/close.png" id="btnCloseLayer" style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1" onclick="closeDaumPostcode()" alt="닫기 버튼">
			  	</div>
				<div class="col-md-12">
					<input v-model="request" class="order-state" type="text" name="order-state" placeholder="배송 요청 사항">
				</div>
				<div v-if="!checkLogin()" class="col-md-12">
					<input v-model="anony_pw" class="order-state" type="password" name="order-state" placeholder="비회원 주문 비밀번호">
				</div>
				<div class="col-md-6">
					<div class="l2-bnt-block">
						<select class="order-country" v-model="pay_method">
							<option value="card">카드 결제</option>
							<option value="trans">실시간 계좌 이체</option>
						</select>
					</div>
				</div>
				<div class="col-md-12 order-button-block">
					<button v-on:click="buy_req()" type="button" class="button order-button" title="Order">Order Now</button>
				</div>

			</form>
			<!-- End Order Form -->

		</div> <!-- .order-form-content -->

	</section>
	<!-- End Popup -->
	<% include popup.ejs %>
</div>
<!-- Include JS -->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/device.min.js"></script>
<script src="/assets/js/retina.min.js"></script>
<script src="/assets/js/nav.js"></script>
<script src="/assets/js/smooth-scroll.min.js"></script>
<script src="/assets/js/parallax.js"></script>
<script src="/assets/js/aos.js"></script>
<script src="/assets/js/flexslider.js"></script>
<script src="/assets/js/youtubebackground.js"></script>
<script src="/assets/js/magnific-popup.min.js"></script>
<script src="/assets/js/init.js"></script>
<!-- firebase script -->
<script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
<!-- 카카오톡 로그인 API -->
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<!-- 네이버 로그인 API -->
<script type="text/javascript" src="https://static.nid.naver.com/js/naverLogin_implicit-1.0.3.js" charset="utf-8"></script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<!-- 우편번호 스크립트 -->
<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
<% include init.ejs %>
<script>
	    function closeDaumPostcode() {
	        // iframe을 넣은 element를 안보이게 한다.
	        document.getElementById('layer').style.display = 'none';
	    }
	    var IMP = window.IMP; // 생략해도 괜찮습니다.
	    IMP.init("imp33553431"); // "imp00000000" 대신 발급받은 "가맹점 식별코드"를 사용합니다.
</script>
<!-- vue.js 부분 -->
<script type="text/javascript">
new Vue({
	el:'#app',
	data:{
		user:null,
		token:'',
		loginEmailInput:'',
		loginPwInput:'',
		signUpEmailInput:'',
		signUpPwInput:'',
		signUpPwConfirmInput:'',
		signUpNicknameInput:'',
		signUpMessage:'',
		loginMessage:'',
		findPWMessage :'',
		findEmail:'',
		totalPrice:30000,
		carPrice:30000,
		indoor:0,
		order_name:'',
		order_phone:'',
		order_email:'',
		receiver_name:'',
		receiver_phone:'',
		post_code:'',
		normal_address:'',
		addtional_address:'',
		request:'',
		anony_pw:'',
		pay_method:'card',
		car_option:[{text:1,value:30000},{text:2,value:60000},{text:3,value:90000},{text:4,value:120000},{text:5,value:150000}]
	},
	methods:{
		onChange: function (event){
			this.carPrice = event.srcElement.value;
			this.totalPrice = this.carPrice;
		},
		buy_req:function(){
			var regPhone = /^(01[016789]{1})([0-9]{3,4})([0-9]{4})$/;
			var emailRegExp = /([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
			var send_name=this.order_name.trim();
			var send_phone = this.order_phone.trim();
			var email = this.order_email.trim();
			var receive_name = this.receiver_name.trim();
			var receive_phone = this.receiver_phone.trim();
			var receive_postcode = this.post_code.trim();
			var receive_normal_addr = this.normal_address.trim();
			var receive_detail_addr = this.addtional_address.trim();
			var request = this.request;
			var pw = this.anony_pw.trim();
			var pay_method = this.pay_method;
			var total_price = this.totalPrice;
			var car_price = this.carPrice;
			var user_token = this.token;
			if(send_name==''){
				alert("주문자 이름을 입력해 주세요");
				return false;
			} else if(send_phone==''){
				alert("주문자 핸드폰번호를 입력해 주세요");				
				return false;
			} else if(!regPhone.test(send_phone)){
				alert("핸드폰번호는 - 를 제외해서 올바르게 입력해 주세요");
				return false;
			} else if(!emailRegExp.test(email)){
				alert("이메일 번호를 올바르게 입력해 주세요");
			}else if(receive_name==''){
				alert("받으시는 분을 입력해 주세요");
				return false;
			}else if(receive_phone==''){
				alert("배송지 핸드폰번호를 입력해 주세요");
				return false;
			} else if(!regPhone.test(receive_phone)){
				alert("핸드폰번호는 - 를 제외해서 올바르게 입력해 주세요");
				return false;
			} else if(receive_postcode ==''){
				alert("배송지 주소를 입력해 주세요");
				return false;
			}else if(receive_normal_addr ==''){
				alert("배송지 주소를 입력해 주세요");
				return false;
			} else if(receive_detail_addr ==''){
				alert("배송지 주소를 입력해 주세요");
				return false;
			} else if(!((this.checkLogin())||((pw.length>3)&&(pw.length<21)))){
				alert("비밀번호는 4자리 이상 20자리 이하로 해주세요")
			}else {
				var merchant_uid = 'merchant_' + new Date().getTime();
				var escrow = true;
				if(pay_method=='card'){
					escrow =false;
				}
				 IMP.request_pay({ // param
		                pg: "inicis",
		                pay_method: pay_method,
		                merchant_uid: merchant_uid,
		                name: "Air Puri 차량용 청정기",
		                amount: 1000,//total_price,
		                escrow:escrow,
		                buyer_email: email,
		                buyer_name: receive_name,
		                buyer_tel: receive_phone,
		                buyer_addr: receive_normal_addr+' '+receive_detail_addr,
		                buyer_postcode: receive_postcode,
		                custom_data	: {
		                	token : user_token,
					    	request : request,
							receiver_phone : receive_phone,
			    			receiver_name : receive_name,
			    			car_price : car_price,
			    			pw : pw 
		                },
		                m_redirect_url:'http://www.anyair.co.kr/pay-success?amount='+1000
		            }, (rsp) => { // callback
		                if (rsp.success) {
		              		location.replace("/pay-success?amount="+1000+'&imp_uid='+rsp.imp_uid+'&imp_success='+rsp.success); //나중에 total_price로 바꿀껏
		                } else {
		                	alert("결제가 취소되었습니다.");
		                }
		            });
			}
		},
		showPostCode:function(){
				var vm = this;
			   var element_layer = document.getElementById('layer');
			    function sample2_execDaumPostcode() {
			        new daum.Postcode({
			            oncomplete: function(data) {
			                // 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
			
			                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
			                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
			                var fullAddr = data.address; // 최종 주소 변수
			                var extraAddr = ''; // 조합형 주소 변수
			
			                // 기본 주소가 도로명 타입일때 조합한다.
			                if(data.addressType === 'R'){
			                    //법정동명이 있을 경우 추가한다.
			                    if(data.bname !== ''){
			                        extraAddr += data.bname;
			                    }
			                    // 건물명이 있을 경우 추가한다.
			                    if(data.buildingName !== ''){
			                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
			                    }
			                    // 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
			                    fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
			                }
			
			                // 우편번호와 주소 정보를 해당 필드에 넣는다.
			                vm.post_code = data.zonecode;
			                vm.normal_address=fullAddr;
			
			                // iframe을 넣은 element를 안보이게 한다.
			                // (autoClose:false 기능을 이용한다면, 아래 코드를 제거해야 화면에서 사라지지 않는다.)
			                element_layer.style.display = 'none';
			            },
			            width : '100%',
			            height : '100%',
			            maxSuggestItems : 5
			        }).embed(element_layer);
			
			        // iframe을 넣은 element를 보이게 한다.
			        element_layer.style.display = 'block';
			
			        // iframe을 넣은 element의 위치를 화면의 가운데로 이동시킨다.
			        initLayerPosition();
			    }
			
			    // 브라우저의 크기 변경에 따라 레이어를 가운데로 이동시키고자 하실때에는
			    // resize이벤트나, orientationchange이벤트를 이용하여 값이 변경될때마다 아래 함수를 실행 시켜 주시거나,
			    // 직접 element_layer의 top,left값을 수정해 주시면 됩니다.
			    function initLayerPosition(){
			    	var width = 500; //우편번호서비스가 들어갈 element의 width
			    	if((window.innerWidth || document.documentElement.clientWidth)<500){
			    		var width = 300; //우편번호서비스가 들어갈 element의 width	
			    	}
			        
			        var height = 500; //우편번호서비스가 들어갈 element의 height
			        var borderWidth = 2; //샘플에서 사용하는 border의 두께
			
			        // 위에서 선언한 값들을 실제 element에 넣는다.
			        element_layer.style.width = width + 'px';
			        element_layer.style.height = height + 'px';
			        element_layer.style.border = borderWidth + 'px solid';
			        // 실행되는 순간의 화면 너비와 높이 값을 가져와서 중앙에 뜰 수 있도록 위치를 계산한다.
			        element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width)/2 - borderWidth) + 'px';
			        element_layer.style.top = ((((window.innerHeight || document.documentElement.clientHeight) - height)/2 - borderWidth)+80) + 'px';
			    }
			    sample2_execDaumPostcode();
		},
		showModal: function(){
			$.magnificPopup.open({
				items:{
					src:'#order'
				},
				type:'inline',
			    midClick: true,
			    removalDelay: 300,
			    mainClass: 'mfp-fade'
			});
		},
		<% include navbar.js %>
	},
	beforeCreate: function(){
		Kakao.init('8cfff2d2abaa58507a1576a56585356c');
		firebase.auth().onAuthStateChanged((user) => {
	        if (user) {
	          this.user = user;
	          this.order_name = user.displayName;
	          this.order_email = user.email;
	          var vm = this;
	          user.getIdToken(true).then(function(idToken){
		     		vm.token = idToken;
		     	});
	        } else{
	        	this.anony_pw='';
	        	this.token='';
	        }
	      });
		//여기다가 firebase init 넣어야함
		//dom 생성되기전에 실행되는 함수
	}
});

</script>

	<script>
	    // 우편번호 찾기 화면을 넣을 element
	 
	</script>
<!--[if lte IE 9]>
<script src="assets/js/placeholders.js"></script>
<script src="assets/js/init-for-ie.js"></script>
<![endif]-->

</body>
</html>